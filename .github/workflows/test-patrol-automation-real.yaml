name: Patrol Setup on Ubuntu Latest

on:
  workflow_dispatch:

jobs:
  patrol-test:
    runs-on: ubuntu-latest

    steps:
      # à¸”à¸¶à¸‡ Source Code à¸‚à¸­à¸‡à¹‚à¸›à¸£à¹€à¸ˆà¸à¸•à¹Œ
      - name: Checkout Code
        uses: actions/checkout@v4

      # à¸•à¸´à¸”à¸•à¸±à¹‰à¸‡ Java (à¸ˆà¸³à¹€à¸›à¹‡à¸™à¸ªà¸³à¸«à¸£à¸±à¸š Android SDK à¹à¸¥à¸° Gradle)
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: "zulu"
          java-version: "17"

      # à¸•à¸´à¸”à¸•à¸±à¹‰à¸‡ Flutter à¹à¸¥à¸° Dart à¸à¸·à¹‰à¸™à¸à¸²à¸™à¹€à¸‚à¹‰à¸²à¹„à¸›à¹ƒà¸™ Runner
      - name: Setup Flutter and Dart
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"
          cache: true

      # à¸•à¸´à¸”à¸•à¸±à¹‰à¸‡ FVM 
      - name: Install FVM
        run: dart pub global activate fvm

      # à¸•à¸´à¸”à¸•à¸±à¹‰à¸‡ Flutter SDK à¸•à¸²à¸¡à¹€à¸§à¸­à¸£à¹Œà¸Šà¸±à¸™à¹ƒà¸™à¹„à¸Ÿà¸¥à¹Œ .fvm/fvm_config.json
      - name: Install Flutter SDK via FVM
        run: fvm install

      # à¸•à¸´à¸”à¸•à¸±à¹‰à¸‡ Patrol CLI à¹à¸¥à¸°à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸² PATH
      - name: Setup Patrol CLI
        run: |
          dart pub global activate patrol_cli
          echo "$HOME/.pub-cache/bin" >> $GITHUB_PATH

      # à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸² Android SDK
      - name: Setup Android SDK
        run: |
          echo "ğŸ¤– Accepting Licenses and Installing Android SDK Components..."
          echo "y" | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses
          $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "platforms;android-36" "build-tools;36.1.0" "platform-tools"

      # à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸² Android platform-tools
      - name: Add Android platform-tools to PATH
        run: echo "$ANDROID_HOME/platform-tools" >> $GITHUB_PATH

      # à¸¢à¸­à¸¡à¸£à¸±à¸š Flutter Android Licenses
      - name: Configure Flutter and Accept Licenses
        run: |
          echo "ğŸ¤– Disabling Linux Desktop to speed up CI and clear Doctor warnings..."
          fvm flutter config --no-enable-linux-desktop
          echo "ğŸ¤– Accepting Flutter Android Licenses..."
          yes | fvm flutter doctor --android-licenses

      # à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š Dependency à¸‚à¸­à¸‡ Flutter à¹à¸¥à¸° Patrol
      - name: Check Patrol Doctor and Flutter Doctor
        run: |
          echo "ğŸš€ Final Check with Patrol Doctor..."
          patrol doctor
          echo "ğŸš€ Final Check with Flutter Doctor..."
          fvm flutter doctor -v
